$(function(){var serverBasic="",trTemplate='<tr class="odd gradeX">\n                            <td>{{Cost}}</td>\n                            <td class="sql-text">{{Sql}}</td>\n                            <td>{{Date}}</td>\n                            <td><input type="button" value="view" class="btn btn-default btn-sm btn-sql-view"  data-toggle="modal" data-target="#sqlModal" data-info="{{Detail}}"></td>\n                        </tr>';$(".btn-load-sql-agent").click(function(){$.get(serverBasic+"sql_stat/load_agent/"+$("#vm-id").val(),function(response){response=eval("("+response+")"),"success"==response.status?(console.log(response.message),alert("成功载入sql agent"),dealBtnAndLoadList("success","true")):(console.log(response.message),alert("载入失败"))})}),$('a[data-id="sql-panel"]').click(function(){$.get(serverBasic+"sql_stat/is_load_agent/"+$("#vm-id").val(),function(response){response=eval("("+response+")"),dealBtnAndLoadList(response.status,response.message)})}),$(".vm-list").on("click",".vm-title",function(){var vmId=$(this).attr("data-vm-id");$("#sql-list").html(""),$.get(serverBasic+"sql_stat/is_load_agent/"+vmId,function(response){response=eval("("+response+")"),dealBtnAndLoadList(response.status,response.message)})}),$(".btn-load-sql-list").click(function(){loadSqlList(1,10,!0)}),$(".btn-filter-submit").click(function(){loadSqlList(1,10,!1)});var dealBtnAndLoadList=function(t,s){"success"==t?"true"==s?($(".btn-load-sql-agent").addClass("disabled"),$(".btn-load-sql-agent").attr("disabled","true"),$(".btn-load-sql-list").removeClass("disabled"),$(".btn-load-sql-list").removeAttr("disabled"),loadSqlList()):($(".btn-load-sql-agent").removeClass("disabled"),$(".btn-load-sql-agent").removeAttr("disabled"),$(".btn-load-sql-list").addClass("disabled"),$(".btn-load-sql-list").attr("disabled","true")):($(".btn-load-sql-agent").addClass("disabled"),$(".btn-load-sql-agent").attr("disabled","true"),$(".btn-load-sql-list").addClass("disabled"),$(".btn-load-sql-list").attr("disabled","true"))},loadSqlList=function(index,size,refresh){if(!$("#sql-panel").is(":visible"))return!1;index||(index=1),size||(size=10);var url=serverBasic+"sql_stat/load_sql_list/"+$("#vm-id").val()+"/"+size+"/"+index+"/";url+=refresh?"1":"0";var min=$(".sql-filter-min").val(),max=$(".sql-filter-max").val();min||(min=0),max||(max=0);var params={min:min,max:max};$.get(url,params,function(response){if(response=eval("("+response+")"),"failed"==response.status)return!1;var data=response.data.List,total=response.data.Total;$("#sql-list").html("");for(var i=0;i<data.length;i++){var cost=data[i].cost,sql=data[i].sql,date=new Date(data[i].date.time).format("yyyy-MM-dd HH:mm:ss.S"),temp=trTemplate.replace(/{{Cost}}/g,cost+"ms").replace(/{{Sql}}/g,sql).replace(/{{Date}}/g,date);$("#sql-list").append(temp)}$(".sql-page-bar").pageBar(total,index,size)})};$(".sql-page-bar").on("click",".go-page",function(){var t=new Number($(this).attr("data-index"));loadSqlList(t)}),$("#sql-list").on("click",".btn-sql-view",function(){$(".sql-modal-body").html($(this).parent().parent().find(".sql-text").text())}),Date.prototype.format=function(t){var s={"M+":this.getMonth()+1,"d+":this.getDate(),"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var e in s)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?s[e]:("00"+s[e]).substr((""+s[e]).length)));return t}});